<?php

namespace Database\Seeders;

use Illuminate\Database\Seeder;
use BezhanSalleh\FilamentShield\Support\Utils;
use Spatie\Permission\PermissionRegistrar;

class ShieldSeeder extends Seeder
{
    public function run(): void
    {
        app()[PermissionRegistrar::class]->forgetCachedPermissions();

        $rolesWithPermissions = '[{"name":"Admin","guard_name":"web","permissions":["view_call","create_user","update_user","delete_user","restore_any_user"]},{"name":"User","guard_name":"web","permissions":[]},{"name":"super_admin","guard_name":"web","permissions":[]}]';
        $directPermissions = '{"5":{"name":"view_branch","guard_name":"web"},"6":{"name":"view_any_branch","guard_name":"web"},"7":{"name":"create_branch","guard_name":"web"},"8":{"name":"update_branch","guard_name":"web"},"9":{"name":"restore_branch","guard_name":"web"},"10":{"name":"restore_any_branch","guard_name":"web"},"11":{"name":"replicate_branch","guard_name":"web"},"12":{"name":"reorder_branch","guard_name":"web"},"13":{"name":"delete_branch","guard_name":"web"},"14":{"name":"delete_any_branch","guard_name":"web"},"15":{"name":"force_delete_branch","guard_name":"web"},"16":{"name":"force_delete_any_branch","guard_name":"web"},"17":{"name":"view_any_call","guard_name":"web"},"18":{"name":"create_call","guard_name":"web"},"19":{"name":"update_call","guard_name":"web"},"20":{"name":"restore_call","guard_name":"web"},"21":{"name":"restore_any_call","guard_name":"web"},"22":{"name":"replicate_call","guard_name":"web"},"23":{"name":"reorder_call","guard_name":"web"},"24":{"name":"delete_call","guard_name":"web"},"25":{"name":"delete_any_call","guard_name":"web"},"26":{"name":"force_delete_call","guard_name":"web"},"27":{"name":"force_delete_any_call","guard_name":"web"},"28":{"name":"view_call::result","guard_name":"web"},"29":{"name":"view_any_call::result","guard_name":"web"},"30":{"name":"create_call::result","guard_name":"web"},"31":{"name":"update_call::result","guard_name":"web"},"32":{"name":"restore_call::result","guard_name":"web"},"33":{"name":"restore_any_call::result","guard_name":"web"},"34":{"name":"replicate_call::result","guard_name":"web"},"35":{"name":"reorder_call::result","guard_name":"web"},"36":{"name":"delete_call::result","guard_name":"web"},"37":{"name":"delete_any_call::result","guard_name":"web"},"38":{"name":"force_delete_call::result","guard_name":"web"},"39":{"name":"force_delete_any_call::result","guard_name":"web"},"40":{"name":"view_chronic","guard_name":"web"},"41":{"name":"view_any_chronic","guard_name":"web"},"42":{"name":"create_chronic","guard_name":"web"},"43":{"name":"update_chronic","guard_name":"web"},"44":{"name":"restore_chronic","guard_name":"web"},"45":{"name":"restore_any_chronic","guard_name":"web"},"46":{"name":"replicate_chronic","guard_name":"web"},"47":{"name":"reorder_chronic","guard_name":"web"},"48":{"name":"delete_chronic","guard_name":"web"},"49":{"name":"delete_any_chronic","guard_name":"web"},"50":{"name":"force_delete_chronic","guard_name":"web"},"51":{"name":"force_delete_any_chronic","guard_name":"web"},"52":{"name":"view_cohort","guard_name":"web"},"53":{"name":"view_any_cohort","guard_name":"web"},"54":{"name":"create_cohort","guard_name":"web"},"55":{"name":"update_cohort","guard_name":"web"},"56":{"name":"restore_cohort","guard_name":"web"},"57":{"name":"restore_any_cohort","guard_name":"web"},"58":{"name":"replicate_cohort","guard_name":"web"},"59":{"name":"reorder_cohort","guard_name":"web"},"60":{"name":"delete_cohort","guard_name":"web"},"61":{"name":"delete_any_cohort","guard_name":"web"},"62":{"name":"force_delete_cohort","guard_name":"web"},"63":{"name":"force_delete_any_cohort","guard_name":"web"},"64":{"name":"view_diagnosis","guard_name":"web"},"65":{"name":"view_any_diagnosis","guard_name":"web"},"66":{"name":"create_diagnosis","guard_name":"web"},"67":{"name":"update_diagnosis","guard_name":"web"},"68":{"name":"restore_diagnosis","guard_name":"web"},"69":{"name":"restore_any_diagnosis","guard_name":"web"},"70":{"name":"replicate_diagnosis","guard_name":"web"},"71":{"name":"reorder_diagnosis","guard_name":"web"},"72":{"name":"delete_diagnosis","guard_name":"web"},"73":{"name":"delete_any_diagnosis","guard_name":"web"},"74":{"name":"force_delete_diagnosis","guard_name":"web"},"75":{"name":"force_delete_any_diagnosis","guard_name":"web"},"76":{"name":"view_medication","guard_name":"web"},"77":{"name":"view_any_medication","guard_name":"web"},"78":{"name":"create_medication","guard_name":"web"},"79":{"name":"update_medication","guard_name":"web"},"80":{"name":"restore_medication","guard_name":"web"},"81":{"name":"restore_any_medication","guard_name":"web"},"82":{"name":"replicate_medication","guard_name":"web"},"83":{"name":"reorder_medication","guard_name":"web"},"84":{"name":"delete_medication","guard_name":"web"},"85":{"name":"delete_any_medication","guard_name":"web"},"86":{"name":"force_delete_medication","guard_name":"web"},"87":{"name":"force_delete_any_medication","guard_name":"web"},"88":{"name":"view_medication::use","guard_name":"web"},"89":{"name":"view_any_medication::use","guard_name":"web"},"90":{"name":"create_medication::use","guard_name":"web"},"91":{"name":"update_medication::use","guard_name":"web"},"92":{"name":"restore_medication::use","guard_name":"web"},"93":{"name":"restore_any_medication::use","guard_name":"web"},"94":{"name":"replicate_medication::use","guard_name":"web"},"95":{"name":"reorder_medication::use","guard_name":"web"},"96":{"name":"delete_medication::use","guard_name":"web"},"97":{"name":"delete_any_medication::use","guard_name":"web"},"98":{"name":"force_delete_medication::use","guard_name":"web"},"99":{"name":"force_delete_any_medication::use","guard_name":"web"},"100":{"name":"view_nutrition","guard_name":"web"},"101":{"name":"view_any_nutrition","guard_name":"web"},"102":{"name":"create_nutrition","guard_name":"web"},"103":{"name":"update_nutrition","guard_name":"web"},"104":{"name":"restore_nutrition","guard_name":"web"},"105":{"name":"restore_any_nutrition","guard_name":"web"},"106":{"name":"replicate_nutrition","guard_name":"web"},"107":{"name":"reorder_nutrition","guard_name":"web"},"108":{"name":"delete_nutrition","guard_name":"web"},"109":{"name":"delete_any_nutrition","guard_name":"web"},"110":{"name":"force_delete_nutrition","guard_name":"web"},"111":{"name":"force_delete_any_nutrition","guard_name":"web"},"112":{"name":"view_patient","guard_name":"web"},"113":{"name":"view_any_patient","guard_name":"web"},"114":{"name":"create_patient","guard_name":"web"},"115":{"name":"update_patient","guard_name":"web"},"116":{"name":"restore_patient","guard_name":"web"},"117":{"name":"restore_any_patient","guard_name":"web"},"118":{"name":"replicate_patient","guard_name":"web"},"119":{"name":"reorder_patient","guard_name":"web"},"120":{"name":"delete_patient","guard_name":"web"},"121":{"name":"delete_any_patient","guard_name":"web"},"122":{"name":"force_delete_patient","guard_name":"web"},"123":{"name":"force_delete_any_patient","guard_name":"web"},"124":{"name":"view_physiotherapy","guard_name":"web"},"125":{"name":"view_any_physiotherapy","guard_name":"web"},"126":{"name":"create_physiotherapy","guard_name":"web"},"127":{"name":"update_physiotherapy","guard_name":"web"},"128":{"name":"restore_physiotherapy","guard_name":"web"},"129":{"name":"restore_any_physiotherapy","guard_name":"web"},"130":{"name":"replicate_physiotherapy","guard_name":"web"},"131":{"name":"reorder_physiotherapy","guard_name":"web"},"132":{"name":"delete_physiotherapy","guard_name":"web"},"133":{"name":"delete_any_physiotherapy","guard_name":"web"},"134":{"name":"force_delete_physiotherapy","guard_name":"web"},"135":{"name":"force_delete_any_physiotherapy","guard_name":"web"},"136":{"name":"view_procedure","guard_name":"web"},"137":{"name":"view_any_procedure","guard_name":"web"},"138":{"name":"create_procedure","guard_name":"web"},"139":{"name":"update_procedure","guard_name":"web"},"140":{"name":"restore_procedure","guard_name":"web"},"141":{"name":"restore_any_procedure","guard_name":"web"},"142":{"name":"replicate_procedure","guard_name":"web"},"143":{"name":"reorder_procedure","guard_name":"web"},"144":{"name":"delete_procedure","guard_name":"web"},"145":{"name":"delete_any_procedure","guard_name":"web"},"146":{"name":"force_delete_procedure","guard_name":"web"},"147":{"name":"force_delete_any_procedure","guard_name":"web"},"148":{"name":"view_psychosocial","guard_name":"web"},"149":{"name":"view_any_psychosocial","guard_name":"web"},"150":{"name":"create_psychosocial","guard_name":"web"},"151":{"name":"update_psychosocial","guard_name":"web"},"152":{"name":"restore_psychosocial","guard_name":"web"},"153":{"name":"restore_any_psychosocial","guard_name":"web"},"154":{"name":"replicate_psychosocial","guard_name":"web"},"155":{"name":"reorder_psychosocial","guard_name":"web"},"156":{"name":"delete_psychosocial","guard_name":"web"},"157":{"name":"delete_any_psychosocial","guard_name":"web"},"158":{"name":"force_delete_psychosocial","guard_name":"web"},"159":{"name":"force_delete_any_psychosocial","guard_name":"web"},"160":{"name":"view_role","guard_name":"web"},"161":{"name":"view_any_role","guard_name":"web"},"162":{"name":"create_role","guard_name":"web"},"163":{"name":"update_role","guard_name":"web"},"164":{"name":"delete_role","guard_name":"web"},"165":{"name":"delete_any_role","guard_name":"web"},"166":{"name":"view_route","guard_name":"web"},"167":{"name":"view_any_route","guard_name":"web"},"168":{"name":"create_route","guard_name":"web"},"169":{"name":"update_route","guard_name":"web"},"170":{"name":"restore_route","guard_name":"web"},"171":{"name":"restore_any_route","guard_name":"web"},"172":{"name":"replicate_route","guard_name":"web"},"173":{"name":"reorder_route","guard_name":"web"},"174":{"name":"delete_route","guard_name":"web"},"175":{"name":"delete_any_route","guard_name":"web"},"176":{"name":"force_delete_route","guard_name":"web"},"177":{"name":"force_delete_any_route","guard_name":"web"},"178":{"name":"view_scheme","guard_name":"web"},"179":{"name":"view_any_scheme","guard_name":"web"},"180":{"name":"create_scheme","guard_name":"web"},"181":{"name":"update_scheme","guard_name":"web"},"182":{"name":"restore_scheme","guard_name":"web"},"183":{"name":"restore_any_scheme","guard_name":"web"},"184":{"name":"replicate_scheme","guard_name":"web"},"185":{"name":"reorder_scheme","guard_name":"web"},"186":{"name":"delete_scheme","guard_name":"web"},"187":{"name":"delete_any_scheme","guard_name":"web"},"188":{"name":"force_delete_scheme","guard_name":"web"},"189":{"name":"force_delete_any_scheme","guard_name":"web"},"190":{"name":"view_specialist","guard_name":"web"},"191":{"name":"view_any_specialist","guard_name":"web"},"192":{"name":"create_specialist","guard_name":"web"},"193":{"name":"update_specialist","guard_name":"web"},"194":{"name":"restore_specialist","guard_name":"web"},"195":{"name":"restore_any_specialist","guard_name":"web"},"196":{"name":"replicate_specialist","guard_name":"web"},"197":{"name":"reorder_specialist","guard_name":"web"},"198":{"name":"delete_specialist","guard_name":"web"},"199":{"name":"delete_any_specialist","guard_name":"web"},"200":{"name":"force_delete_specialist","guard_name":"web"},"201":{"name":"force_delete_any_specialist","guard_name":"web"},"202":{"name":"view_user","guard_name":"web"},"203":{"name":"view_any_user","guard_name":"web"},"204":{"name":"restore_user","guard_name":"web"},"205":{"name":"replicate_user","guard_name":"web"},"206":{"name":"reorder_user","guard_name":"web"},"207":{"name":"delete_any_user","guard_name":"web"},"208":{"name":"force_delete_user","guard_name":"web"},"209":{"name":"force_delete_any_user","guard_name":"web"}}';

        static::makeRolesWithPermissions($rolesWithPermissions);
        static::makeDirectPermissions($directPermissions);

        $this->command->info('Shield Seeding Completed.');
    }

    protected static function makeRolesWithPermissions(string $rolesWithPermissions): void
    {
        if (! blank($rolePlusPermissions = json_decode($rolesWithPermissions, true))) {
            /** @var Model $roleModel */
            $roleModel = Utils::getRoleModel();
            /** @var Model $permissionModel */
            $permissionModel = Utils::getPermissionModel();

            foreach ($rolePlusPermissions as $rolePlusPermission) {
                $role = $roleModel::firstOrCreate([
                    'name' => $rolePlusPermission['name'],
                    'guard_name' => $rolePlusPermission['guard_name'],
                ]);

                if (! blank($rolePlusPermission['permissions'])) {
                    $permissionModels = collect($rolePlusPermission['permissions'])
                        ->map(fn ($permission) => $permissionModel::firstOrCreate([
                            'name' => $permission,
                            'guard_name' => $rolePlusPermission['guard_name'],
                        ]))
                        ->all();

                    $role->syncPermissions($permissionModels);
                }
            }
        }
    }

    public static function makeDirectPermissions(string $directPermissions): void
    {
        if (! blank($permissions = json_decode($directPermissions, true))) {
            /** @var Model $permissionModel */
            $permissionModel = Utils::getPermissionModel();

            foreach ($permissions as $permission) {
                if ($permissionModel::whereName($permission)->doesntExist()) {
                    $permissionModel::create([
                        'name' => $permission['name'],
                        'guard_name' => $permission['guard_name'],
                    ]);
                }
            }
        }
    }
}
